#!/usr/bin/env bash
set -e

echo "=========================================="
echo "DynamoDB Single-Table Complete Dump"
echo "=========================================="
echo ""
echo "This shows the relational projection of"
echo "single-table DynamoDB data."
echo ""

# Show table overview
ENDPOINT="http://localhost:8000"
REGION="us-east-1"
export AWS_ACCESS_KEY_ID=dummy
export AWS_SECRET_ACCESS_KEY=dummy

echo "=========================================="
echo "TABLE OVERVIEW"
echo "=========================================="
echo ""

# Count items by entity type
USER_COUNT=$(aws dynamodb scan \
    --table-name vote_data \
    --filter-expression "begins_with(PK, :prefix) AND SK = :sk" \
    --expression-attribute-values '{":prefix":{"S":"USER#"},":sk":{"S":"METADATA"}}' \
    --select COUNT \
    --endpoint-url "$ENDPOINT" \
    --region "$REGION" \
    2>/dev/null | jq -r '.Count // 0')

ELECTION_COUNT=$(aws dynamodb scan \
    --table-name vote_data \
    --filter-expression "begins_with(PK, :prefix) AND SK = :sk" \
    --expression-attribute-values '{":prefix":{"S":"ELECTION#"},":sk":{"S":"METADATA"}}' \
    --select COUNT \
    --endpoint-url "$ENDPOINT" \
    --region "$REGION" \
    2>/dev/null | jq -r '.Count // 0')

CANDIDATE_COUNT=$(aws dynamodb scan \
    --table-name vote_data \
    --filter-expression "begins_with(SK, :prefix)" \
    --expression-attribute-values '{":prefix":{"S":"CANDIDATE#"}}' \
    --select COUNT \
    --endpoint-url "$ENDPOINT" \
    --region "$REGION" \
    2>/dev/null | jq -r '.Count // 0')

VOTER_COUNT=$(aws dynamodb scan \
    --table-name vote_data \
    --filter-expression "begins_with(SK, :prefix)" \
    --expression-attribute-values '{":prefix":{"S":"VOTER#"}}' \
    --select COUNT \
    --endpoint-url "$ENDPOINT" \
    --region "$REGION" \
    2>/dev/null | jq -r '.Count // 0')

BALLOT_COUNT=$(aws dynamodb scan \
    --table-name vote_data \
    --filter-expression "begins_with(SK, :prefix)" \
    --expression-attribute-values '{":prefix":{"S":"BALLOT#"}}' \
    --select COUNT \
    --endpoint-url "$ENDPOINT" \
    --region "$REGION" \
    2>/dev/null | jq -r '.Count // 0')

printf "%-25s %3d records\n" "Users:" "$USER_COUNT"
printf "%-25s %3d records\n" "Elections:" "$ELECTION_COUNT"
printf "%-25s %3d records\n" "Candidates:" "$CANDIDATE_COUNT"
printf "%-25s %3d records\n" "Eligible Voters:" "$VOTER_COUNT"
printf "%-25s %3d records\n" "Ballots:" "$BALLOT_COUNT"

echo ""
echo ""

# Show detailed contents
echo "=========================================="
echo "USERS"
echo "=========================================="
./scripts/inspect-dynamodb-single-users
echo ""
echo ""

echo "=========================================="
echo "ELECTIONS"
echo "=========================================="
./scripts/inspect-dynamodb-single-elections
echo ""
echo ""

echo "=========================================="
echo "BALLOTS"
echo "=========================================="
./scripts/inspect-dynamodb-single-ballots
echo ""
