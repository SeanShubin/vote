#!/usr/bin/env bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
LOG_DIR="$PROJECT_DIR/logs"

mkdir -p "$LOG_DIR"

echo "=== Launch Keep DynamoDB ==="
echo

# 1. Terminate existing processes
echo "1. Terminating existing processes..."
"$SCRIPT_DIR/terminate-all"
sleep 1

# 2. Roll logs
echo "2. Rolling logs..."
"$SCRIPT_DIR/roll-logs"

# 3. Build frontend if needed
if [ ! -d "$PROJECT_DIR/frontend/build/dist/js/productionExecutable" ]; then
  echo "3. Building frontend..."
  cd "$PROJECT_DIR"
  ./gradlew :frontend:build --no-daemon
else
  echo "3. Frontend already built"
fi

# 4. Start backend
echo "4. Starting backend (DynamoDB)..."
cd "$PROJECT_DIR"
./gradlew :backend:run --args="8080 dynamodb" --console=plain > "$LOG_DIR/backend.log" 2>&1 &
BACKEND_PID=$!
echo "   Backend started (PID: $BACKEND_PID, log: logs/backend.log)"

# 5. Start frontend
echo "5. Starting frontend server..."
cd "$PROJECT_DIR/frontend/build/dist/js/productionExecutable"
python3 -m http.server 3000 > "$LOG_DIR/frontend.log" 2>&1 &
FRONTEND_PID=$!
echo "   Frontend started (PID: $FRONTEND_PID, log: logs/frontend.log)"

# 6. Wait for backend
echo "6. Waiting for backend to be ready..."
for i in {1..30}; do
  if curl -s http://localhost:8080/health > /dev/null 2>&1; then
    echo "   Backend ready!"
    break
  fi
  if [ $i -eq 30 ]; then
    echo "   ERROR: Backend did not start within 30 seconds"
    echo "   Check logs/backend.log for details"
    exit 1
  fi
  sleep 1
done

# 7. Wait for frontend
echo "7. Waiting for frontend to be ready..."
for i in {1..10}; do
  if curl -s http://localhost:3000 > /dev/null 2>&1; then
    echo "   Frontend ready!"
    break
  fi
  if [ $i -eq 10 ]; then
    echo "   ERROR: Frontend did not start within 10 seconds"
    echo "   Check logs/frontend.log for details"
    exit 1
  fi
  sleep 1
done

# 8. Open browser
echo "8. Opening browser..."
open http://localhost:3000

echo
echo "=== Development Environment Ready ==="
echo "Backend:  http://localhost:8080 (DynamoDB)"
echo "Frontend: http://localhost:3000"
echo "Logs:     logs/backend.log, logs/frontend.log"
echo
echo "To stop: ./scripts/terminate-all"
