#!/usr/bin/env bash
set -e

ENDPOINT="http://localhost:8000"
export AWS_ACCESS_KEY_ID=dummy
export AWS_SECRET_ACCESS_KEY=dummy
REGION="us-east-1"

echo "=== Ballots (Single-Table) ==="
echo ""

if [ -n "$1" ]; then
    # Query specific election (PK = ELECTION#name, SK begins with BALLOT#)
    result=$(aws dynamodb query \
        --table-name vote_data \
        --key-condition-expression "PK = :pk AND begins_with(SK, :sk)" \
        --expression-attribute-values "{\":pk\":{\"S\":\"ELECTION#$1\"},\":sk\":{\"S\":\"BALLOT#\"}}" \
        --endpoint-url "$ENDPOINT" \
        --region "$REGION" \
        2>/dev/null)

    count=$(echo "$result" | jq -r '.Count // 0')

    if [ "$count" -eq 0 ]; then
        echo "No ballots found for election: $1"
    else
        echo "Found $count ballot(s) for election: $1"
        echo ""
        echo "$result" | jq -r '.Items[] |
            "Voter:        " + .voterName.S + "\n" +
            "Rankings:     " + .rankings.S + "\n" +
            "Confirmation: " + .confirmation.S + "\n" +
            "When Cast:    " + .whenCast.N + " (epoch ms)\n"'
    fi
else
    # Scan all ballots (SK begins with BALLOT#)
    result=$(aws dynamodb scan \
        --table-name vote_data \
        --filter-expression "begins_with(SK, :sk)" \
        --expression-attribute-values '{":sk":{"S":"BALLOT#"}}' \
        --endpoint-url "$ENDPOINT" \
        --region "$REGION" \
        2>/dev/null)

    count=$(echo "$result" | jq -r '.Count // 0')

    if [ "$count" -eq 0 ]; then
        echo "No ballots found."
    else
        echo "Found $count ballot(s):"
        echo ""
        echo "$result" | jq -r '.Items[] |
            "Election:     " + .electionName.S + "\n" +
            "Voter:        " + .voterName.S + "\n" +
            "Rankings:     " + .rankings.S + "\n" +
            "Confirmation: " + .confirmation.S + "\n" +
            "When Cast:    " + .whenCast.N + " (epoch ms)\n"'
    fi

    echo ""
    echo "Tip: Run with election name to see ballots for specific election:"
    echo "  ./scripts/inspect-dynamodb-ballots \"Best Programming Language\""
fi
