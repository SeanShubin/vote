#!/usr/bin/env bash
set -euo pipefail

# End-to-end lifecycle test
# Tests complete lifecycle: start empty -> create users/elections -> cleanup -> end empty

BASE_URL="${1:-http://localhost:8080}"
VERBOSE="${VERBOSE:-false}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[TEST]${NC} $*"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $*"
}

# Make HTTP request and extract JSON field
http_post() {
    local url="$1"
    local data="$2"
    local auth="${3:-}"

    if [ -n "$auth" ]; then
        curl -s -X POST "$BASE_URL$url" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $auth" \
            -d "$data"
    else
        curl -s -X POST "$BASE_URL$url" \
            -H "Content-Type: application/json" \
            -d "$data"
    fi
}

http_get() {
    local url="$1"
    local auth="${2:-}"

    if [ -n "$auth" ]; then
        curl -s -X GET "$BASE_URL$url" \
            -H "Authorization: Bearer $auth"
    else
        curl -s -X GET "$BASE_URL$url"
    fi
}

http_put() {
    local url="$1"
    local data="$2"
    local auth="$3"

    curl -s -X PUT "$BASE_URL$url" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $auth" \
        -d "$data"
}

http_delete() {
    local url="$1"
    local auth="$2"

    curl -s -X DELETE "$BASE_URL$url" \
        -H "Authorization: Bearer $auth"
}

# Extract access token from response
extract_access_token() {
    echo "$1" | jq -r '.accessToken | @json'
}

# Extract count from response
extract_count() {
    echo "$1" | jq -r '.count'
}

log "Starting end-to-end lifecycle test against $BASE_URL"
log ""

# Step 1: Health check
log "1. Health check"
HEALTH=$(http_get "/health")
STATUS=$(echo "$HEALTH" | jq -r '.status')
if [ "$STATUS" != "ok" ]; then
    error "Health check failed: $STATUS"
fi
log "   ✓ Health check passed"
log ""

# Step 2: Verify empty system
log "2. Verify system starts empty"
# Can't check counts without auth, so we'll verify after first user registration
log "   (Will verify after first user registration)"
log ""

# Step 3: Register first user (becomes OWNER)
log "3. Register first user (alice - becomes OWNER)"
ALICE_REG=$(http_post "/register" '{
    "userName": "alice",
    "email": "alice@example.com",
    "password": "password123"
}')
ALICE_TOKEN=$(extract_access_token "$ALICE_REG")
if [ -z "$ALICE_TOKEN" ] || [ "$ALICE_TOKEN" = "null" ]; then
    error "Failed to register alice"
fi
log "   ✓ Alice registered (OWNER)"
log ""

# Step 4: Verify counts (should be 1 user, 0 elections)
log "4. Verify initial counts"
USER_COUNT=$(extract_count "$(http_get "/users/count" "$ALICE_TOKEN")")
ELECTION_COUNT=$(extract_count "$(http_get "/elections/count" "$ALICE_TOKEN")")
if [ "$USER_COUNT" != "1" ]; then
    error "Expected 1 user, got $USER_COUNT"
fi
if [ "$ELECTION_COUNT" != "0" ]; then
    error "Expected 0 elections, got $ELECTION_COUNT"
fi
log "   ✓ Users: $USER_COUNT, Elections: $ELECTION_COUNT"
log ""

# Step 5: Register second user (bob - becomes USER)
log "5. Register second user (bob - becomes USER)"
BOB_REG=$(http_post "/register" '{
    "userName": "bob",
    "email": "bob@example.com",
    "password": "password456"
}')
BOB_TOKEN=$(extract_access_token "$BOB_REG")
if [ -z "$BOB_TOKEN" ] || [ "$BOB_TOKEN" = "null" ]; then
    error "Failed to register bob"
fi
log "   ✓ Bob registered (USER)"
log ""

# Step 6: Register third user (charlie - becomes USER)
log "6. Register third user (charlie - becomes USER)"
CHARLIE_REG=$(http_post "/register" '{
    "userName": "charlie",
    "email": "charlie@example.com",
    "password": "password789"
}')
CHARLIE_TOKEN=$(extract_access_token "$CHARLIE_REG")
if [ -z "$CHARLIE_TOKEN" ] || [ "$CHARLIE_TOKEN" = "null" ]; then
    error "Failed to register charlie"
fi
log "   ✓ Charlie registered (USER)"
log ""

# Step 7: List users
log "7. List all users"
USERS=$(http_get "/users" "$ALICE_TOKEN")
USER_COUNT=$(echo "$USERS" | jq 'length')
if [ "$USER_COUNT" != "3" ]; then
    error "Expected 3 users, got $USER_COUNT"
fi
log "   ✓ Found $USER_COUNT users"
log ""

# Step 8: Create election
log "8. Create election (Best Programming Language)"
ELECTION_NAME="Best Programming Language"
http_post "/election" '{
    "userName": "alice",
    "electionName": "Best Programming Language"
}' "$ALICE_TOKEN" > /dev/null
log "   ✓ Election created"
log ""

# URL encode the election name for use in paths
ELECTION_PATH=$(echo -n "$ELECTION_NAME" | jq -sRr @uri)

# Step 9: Set candidates
log "9. Set candidates"
http_put "/election/$ELECTION_PATH/candidates" '{
    "candidateNames": ["Kotlin", "Python", "Rust", "TypeScript"]
}' "$ALICE_TOKEN" > /dev/null
log "   ✓ Candidates set"
log ""

# Step 10: Set eligible voters
log "10. Set eligible voters"
http_put "/election/$ELECTION_PATH/eligibility" '{
    "voterNames": ["alice", "bob", "charlie"]
}' "$ALICE_TOKEN" > /dev/null
log "   ✓ Eligible voters set"
log ""

# Step 11: Launch election
log "11. Launch election"
http_post "/election/$ELECTION_PATH/launch" '{
    "allowEdit": true
}' "$ALICE_TOKEN" > /dev/null
log "   ✓ Election launched"
log ""

# Step 12: Cast ballots
log "12. Cast ballots"
http_post "/election/$ELECTION_PATH/ballot" '{
    "voterName": "alice",
    "rankings": [
        {"candidateName": "Kotlin", "rank": 1},
        {"candidateName": "Rust", "rank": 2},
        {"candidateName": "Python", "rank": 3},
        {"candidateName": "TypeScript", "rank": 4}
    ]
}' "$ALICE_TOKEN" > /dev/null
log "   ✓ Alice voted"

http_post "/election/$ELECTION_PATH/ballot" '{
    "voterName": "bob",
    "rankings": [
        {"candidateName": "Python", "rank": 1},
        {"candidateName": "Kotlin", "rank": 2},
        {"candidateName": "TypeScript", "rank": 3},
        {"candidateName": "Rust", "rank": 4}
    ]
}' "$BOB_TOKEN" > /dev/null
log "   ✓ Bob voted"

http_post "/election/$ELECTION_PATH/ballot" '{
    "voterName": "charlie",
    "rankings": [
        {"candidateName": "Rust", "rank": 1},
        {"candidateName": "Kotlin", "rank": 2},
        {"candidateName": "Python", "rank": 3},
        {"candidateName": "TypeScript", "rank": 4}
    ]
}' "$CHARLIE_TOKEN" > /dev/null
log "   ✓ Charlie voted"
log ""

# Step 13: List elections
log "13. List elections"
ELECTIONS=$(http_get "/elections" "$ALICE_TOKEN")
ELECTION_COUNT=$(echo "$ELECTIONS" | jq 'length')
if [ "$ELECTION_COUNT" != "1" ]; then
    error "Expected 1 election, got $ELECTION_COUNT"
fi
log "   ✓ Found $ELECTION_COUNT election"
log ""

# Step 14: Finalize election
log "14. Finalize election"
http_post "/election/$ELECTION_PATH/finalize" '{}' "$ALICE_TOKEN" > /dev/null
log "   ✓ Election finalized"
log ""

# Step 15: Delete election
log "15. Delete election"
http_delete "/election/$ELECTION_PATH" "$ALICE_TOKEN" > /dev/null
log "   ✓ Election deleted"
log ""

# Step 16: Verify election count is 0
log "16. Verify election count is 0"
ELECTION_COUNT=$(extract_count "$(http_get "/elections/count" "$ALICE_TOKEN")")
if [ "$ELECTION_COUNT" != "0" ]; then
    error "Expected 0 elections, got $ELECTION_COUNT"
fi
log "   ✓ Elections: $ELECTION_COUNT"
log ""

# Step 17: Alice deletes bob
log "17. Alice deletes bob"
http_delete "/user/bob" "$ALICE_TOKEN" > /dev/null
log "   ✓ Bob deleted"
log ""

# Step 18: Alice deletes charlie
log "18. Alice deletes charlie"
http_delete "/user/charlie" "$ALICE_TOKEN" > /dev/null
log "   ✓ Charlie deleted"
log ""

# Step 19: Verify user count is 1
log "19. Verify user count is 1"
USER_COUNT=$(extract_count "$(http_get "/users/count" "$ALICE_TOKEN")")
if [ "$USER_COUNT" != "1" ]; then
    error "Expected 1 user, got $USER_COUNT"
fi
log "   ✓ Users: $USER_COUNT"
log ""

# Step 20: Alice deletes herself (last user)
log "20. Alice deletes herself (final cleanup)"
http_delete "/user/alice" "$ALICE_TOKEN" > /dev/null
log "   ✓ Alice deleted"
log ""

# Step 21: Verify system is empty again (need to re-register to check)
log "21. Verify system returns to empty state"
VERIFY_REG=$(http_post "/register" '{
    "userName": "verify",
    "email": "verify@example.com",
    "password": "verify123"
}')
VERIFY_TOKEN=$(extract_access_token "$VERIFY_REG")
USER_COUNT=$(extract_count "$(http_get "/users/count" "$VERIFY_TOKEN")")
ELECTION_COUNT=$(extract_count "$(http_get "/elections/count" "$VERIFY_TOKEN")")

# Delete verification user
http_delete "/user/verify" "$VERIFY_TOKEN" > /dev/null

if [ "$USER_COUNT" != "1" ]; then
    error "Expected 1 user (verification user), got $USER_COUNT"
fi
if [ "$ELECTION_COUNT" != "0" ]; then
    error "Expected 0 elections, got $ELECTION_COUNT"
fi
log "   ✓ System returned to empty state"
log ""

log "╔════════════════════════════════════════════════════════════╗"
log "║                                                            ║"
log "║           ✓ ALL TESTS PASSED                              ║"
log "║                                                            ║"
log "║   Complete lifecycle verified:                             ║"
log "║   • Started empty (0 users, 0 elections)                   ║"
log "║   • Created 3 users                                        ║"
log "║   • Created 1 election with 4 candidates                   ║"
log "║   • Set eligible voters                                    ║"
log "║   • Cast 3 ballots                                         ║"
log "║   • Deleted election                                       ║"
log "║   • Deleted all users (including self-deletion)            ║"
log "║   • Ended empty (0 users, 0 elections)                     ║"
log "║                                                            ║"
log "╚════════════════════════════════════════════════════════════╝"
log ""
