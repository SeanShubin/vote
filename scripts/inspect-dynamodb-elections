#!/usr/bin/env bash
set -e

ENDPOINT="http://localhost:8000"
export AWS_ACCESS_KEY_ID=dummy
export AWS_SECRET_ACCESS_KEY=dummy
REGION="us-east-1"

echo "=== Elections (Single-Table) ==="
echo ""

# Query for all election items (PK begins with ELECTION#, SK = METADATA)
result=$(aws dynamodb scan \
    --table-name vote_data \
    --filter-expression "begins_with(PK, :prefix) AND SK = :sk" \
    --expression-attribute-values '{":prefix":{"S":"ELECTION#"},":sk":{"S":"METADATA"}}' \
    --endpoint-url "$ENDPOINT" \
    --region "$REGION" \
    2>/dev/null)

count=$(echo "$result" | jq -r '.Count // 0')

if [ "$count" -eq 0 ]; then
    echo "No elections found."
else
    echo "Found $count election(s):"
    echo ""
    echo "$result" | jq -r '.Items[] |
        "Election:         " + .electionName.S + "\n" +
        "Owner:            " + .ownerName.S + "\n" +
        "Secret Ballot:    " + (.secretBallot.BOOL | tostring) + "\n" +
        "Allow Vote:       " + (.allowVote.BOOL | tostring) + "\n" +
        "Allow Edit:       " + (.allowEdit.BOOL | tostring) + "\n" +
        (if .noVotingBefore then "No Voting Before: " + .noVotingBefore.N + "\n" else "" end) +
        (if .noVotingAfter then "No Voting After:  " + .noVotingAfter.N + "\n" else "" end) +
        ""'
fi
