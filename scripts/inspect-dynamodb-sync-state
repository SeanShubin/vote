#!/usr/bin/env bash
set -e

ENDPOINT="http://localhost:8000"
export AWS_ACCESS_KEY_ID=dummy
export AWS_SECRET_ACCESS_KEY=dummy
REGION="us-east-1"

echo "=== Sync State Table ==="
echo ""

result=$(aws dynamodb scan \
    --table-name vote_sync_state \
    --endpoint-url "$ENDPOINT" \
    --region "$REGION" \
    2>/dev/null)

count=$(echo "$result" | jq -r '.Count // 0')

if [ "$count" -eq 0 ]; then
    echo "No sync state found."
else
    echo "Found $count sync state record(s):"
    echo ""
    echo "$result" | jq -r '.Items[] |
        "ID:                " + .id.S + "\n" +
        (if .last_synced then "Last Synced:       " + .last_synced.N + "\n" else "" end) +
        (if .next_event_id then "Next Event ID:     " + .next_event_id.N + "\n" else "" end) +
        ""'
fi
