#!/usr/bin/env bash
set -e

ENDPOINT="http://localhost:8000"
export AWS_ACCESS_KEY_ID=dummy
export AWS_SECRET_ACCESS_KEY=dummy
REGION="us-east-1"

echo "=== Sync State (Single-Table) ==="
echo ""

# Query for sync state (PK = METADATA, SK = SYNC)
result=$(aws dynamodb get-item \
    --table-name vote_data \
    --key '{"PK":{"S":"METADATA"},"SK":{"S":"SYNC"}}' \
    --endpoint-url "$ENDPOINT" \
    --region "$REGION" \
    2>/dev/null)

item=$(echo "$result" | jq -r '.Item')

if [ "$item" == "null" ] || [ -z "$item" ]; then
    echo "No sync state found."
else
    echo "Sync state:"
    echo ""
    echo "$result" | jq -r '.Item |
        (if .last_synced then "Last Synced: " + .last_synced.N + " (epoch ms)\n" else "Last Synced: Not set\n" end)'
fi
