#!/usr/bin/env bash
set -e

echo "=========================================="
echo "Setting up DynamoDB Local (Single-Table)"
echo "=========================================="
echo ""

# Check if DynamoDB Local container is already running
if docker ps --format '{{.Names}}' | grep -q '^vote-dynamodb$'; then
    echo "✓ DynamoDB Local container already running"
else
    # Check if container exists but is stopped
    if docker ps -a --format '{{.Names}}' | grep -q '^vote-dynamodb$'; then
        echo "Starting existing DynamoDB Local container..."
        docker start vote-dynamodb
    else
        echo "Creating and starting DynamoDB Local container..."
        docker run -d \
            --name vote-dynamodb \
            -p 8000:8000 \
            amazon/dynamodb-local
    fi
    echo "✓ DynamoDB Local container started"
fi

echo ""
echo "Waiting for DynamoDB Local to be ready..."
sleep 3

# Set up AWS credentials for local access
export AWS_ACCESS_KEY_ID=dummy
export AWS_SECRET_ACCESS_KEY=dummy
export AWS_DEFAULT_REGION=us-east-1

echo ""
echo "Creating single-table schema..."

# Create main data table
aws dynamodb create-table \
    --table-name vote_data \
    --attribute-definitions \
        AttributeName=PK,AttributeType=S \
        AttributeName=SK,AttributeType=S \
        AttributeName=GSI1PK,AttributeType=S \
        AttributeName=GSI1SK,AttributeType=S \
    --key-schema \
        AttributeName=PK,KeyType=HASH \
        AttributeName=SK,KeyType=RANGE \
    --global-secondary-indexes \
        "IndexName=email-index,\
KeySchema=[{AttributeName=GSI1PK,KeyType=HASH},{AttributeName=GSI1SK,KeyType=RANGE}],\
Projection={ProjectionType=ALL}" \
    --billing-mode PAY_PER_REQUEST \
    --endpoint-url http://localhost:8000 \
    --region us-east-1 \
    --no-cli-pager \
    2>/dev/null || echo "Note: vote_data table may already exist"

# Create event log table (kept separate)
aws dynamodb create-table \
    --table-name vote_event_log \
    --attribute-definitions AttributeName=event_id,AttributeType=N \
    --key-schema AttributeName=event_id,KeyType=HASH \
    --billing-mode PAY_PER_REQUEST \
    --endpoint-url http://localhost:8000 \
    --region us-east-1 \
    --no-cli-pager \
    2>/dev/null || echo "Note: vote_event_log table may already exist"

echo "✓ Tables created"

echo ""
echo "=========================================="
echo "Setup complete!"
echo "=========================================="
echo ""
echo "DynamoDB Local is running on http://localhost:8000"
echo ""
echo "Tables created:"
echo "  • vote_data (single table with PK/SK design)"
echo "  • vote_event_log (event sourcing)"
echo ""
echo "To stop DynamoDB Local:"
echo "  docker stop vote-dynamodb"
echo ""
echo "To inspect data:"
echo "  ./scripts/inspect-dynamodb-all"
echo ""
